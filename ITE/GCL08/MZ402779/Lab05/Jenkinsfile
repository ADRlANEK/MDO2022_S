pipeline {
	parameters {
		string(name: 'Version', defaultValue: '1.0.0', description: 'Program version')
		booleanParam(name: 'Promote', defaultValue: true, description: 'Promote statement')
	}
    agent any 
    stages {
    	stage('Clone') { 
            steps {
            	echo 'Creating input volume'
                sh 'docker volume create input-volume'
                sh 'docker rm tmp || true'
<<<<<<< HEAD
                sh 'docker run -v input-volume:/data --name tmp node:16-alpine'
                sh 'cd ~/ && ls vscode || git clone --recurse-submodules https://github.com/microsoft/vscode.git'
                sh 'docker cp ~/vscode tmp:/data'
=======
                sh 'docker run -v input-volume:/data --name tmp node'
                sh 'cd ~/ && ls mongo-express || git clone --recurse-submodules https://github.com/mongo-express/mongo-express.git'
                sh 'docker cp ~/mongo-express tmp:/data'
>>>>>>> 66a725769087f1e791dfb30e6f1e11dfdae99889
                sh 'docker rm tmp'
            }
        }
        stage('Build') { 
            steps {
                dir("./ITE/GCL08/MZ402779/Lab05") {
<<<<<<< HEAD
                	sh 'docker build . -t vscode -f dockerfile-build'
                	sh 'docker volume create output-volume'
                	sh 'docker rm vscodebuild || true'
                	sh 'docker run --rm --name vscodebuid --mount type=volume,src="input-volume",dst=/myapp --mount type=volume,src="output-volume",dst=/myapp_build vscode bash -c "cd /myapp/vscode && yarn; cp -R /myapp/vscode /myapp_build"'
=======
                	sh 'docker build . -t mongo-express -f dockerfile-build'
                	sh 'docker volume create output-volume'
                	sh 'docker rm mongobuild || true'
                	sh 'docker run --rm --name mongobuild --mount type=volume,src="input-volume",dst=/myapp --mount type=volume,src="output-volume",dst=/myapp_build mongo-express bash -c "cd /myapp/mongo-express && npm run build; cp -R /myapp/mongo-express /myapp_build"' 
                	sh 'docker volume inspect output-volume' 
>>>>>>> 66a725769087f1e791dfb30e6f1e11dfdae99889
                	     	
                }
            }
        }
        stage('Test') { 
            steps {
                dir("./ITE/GCL08/MZ402779/Lab05") {                	
<<<<<<< HEAD
                	sh 'docker rm vscodetest || true'
                	sh 'docker run --rm --name vscodetest --mount type=volume,src="output-volume",dst=/myapp_build vscode bash -c "cd /myapp_build/vscode && ls -al"'
=======
                	sh 'docker rm mongotests || true'
                	sh 'docker run --rm --name mongotests --mount type=volume,src="output-volume",dst=/myapp_build mongo-express bash -c "cd /myapp_build/mongo-express && mongo-express --url mongodb://127.0.0.1:27017 && npm test"'
>>>>>>> 66a725769087f1e791dfb30e6f1e11dfdae99889
                }
            }
        }
        stage('Deploy') { 
            steps {
<<<<<<< HEAD
                sh 'docker rm vscodedeploy || true'
                sh 'docker run -d --name vscodedeploy --mount type=volume,src="output-volume",dst=/myapp_build vscode bash -c "cd /myapp_build/vscode && npm run"'
                sh 'sleep 5; exit $(docker inspect vscodedeploy --format="{{.State.ExitCode}}")'
                sh 'docker rm -f vscodedeploy'
=======
                sh 'docker rm mongodeploy || true'
                sh 'docker run -d --name mongodeploy --mount type=volume,src="output-volume",dst=/myapp_build mongo-express bash -c "cd /myapp_build/mongo-express && npm run"'
                sh 'sleep 5; exit $(docker inspect mongodeploy --format="{{.State.ExitCode}}")'
                sh 'docker rm -f mongodeploy'
>>>>>>> 66a725769087f1e791dfb30e6f1e11dfdae99889
            }
        }
        stage('Promote'){
        	when {
        		expression {return params.Promote}
        	}
        	steps {
        		sh 'ls /var/jenkins_home/workspace/artifacts || mkdir /var/jenkins_home/workspace/artifacts'
        	}
        }        
        stage('Publish') { 
        when {
        	expression {return params.Promote}
        }  
        agent {
        	docker {
<<<<<<< HEAD
        		image 'node:16-alpine'
=======
        		image 'node:alpine'
>>>>>>> 66a725769087f1e791dfb30e6f1e11dfdae99889
        		args '--rm --mount "type=volume,src=output-volume,dst=/usr/local/app" --mount "type=bind,src=/var/jenkins_home/workspace/artifacts,dst=/usr/local/copy" -u root:root'
        	}
        }      
            steps {
                sh 'rm -rf /usr/local/copy/* || true'
<<<<<<< HEAD
                sh "cd /usr/local/app/vscode && npm version ${params.Version} && npm pack"
                sh "mv /usr/local/app/vscode/code-oss-dev-${params.Version}.tgz /usr/local/copy"
                dir('/var/jenkins_home/workspace/artifacts'){
                	archiveArtifacts artifacts: "code-oss-dev-${params.Version}.tgz",
=======
                sh "cd /usr/local/app/mongoexpress && npm version ${params.Version} && npm pack"
                sh "mv /usr/local/app/mongoexpress/mongo-express-${params.Version}.tgz /usr/local/copy"
                dir('/var/jenkins_home/workspace/artifacts'){
                	archiveArtifacts artifacts: "mongo-express-${params.Version}.tgz",
>>>>>>> 66a725769087f1e791dfb30e6f1e11dfdae99889
                	fingerprint: true
                }
            }
        }
    }
    post {
    	success {
    		echo 'Pipeline executed successfully'
    	}
    	failure {
    		echo 'Pipeline has encountered some errors. Check logs for more information.'
    	}
    }
}
<<<<<<< HEAD

=======
>>>>>>> 66a725769087f1e791dfb30e6f1e11dfdae99889
