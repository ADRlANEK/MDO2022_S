pipeline {
    agent any

    stages {
	stage('Clone repo into vol') {
	    steps {
	        sh 'cd ~/ && git clone --recurse-submodules https://github.com/aristocratos/bashtop.git'
	    }
	}
        stage('Build') {
            agent {
                docker {
                  image 'ubuntu'
                  args '--mount type=bind,source=~/bashtop,target=/app/bashtop --mount type=volume,src="vol-out",dst=/app/build'
                }
            }  
	    steps {
                echo 'Installing bashtop'
                sh 'cd bashtop && make install'
            }
        }
        stage('Test') {
            steps {
                echo 'Testing bashtop'
                dir("./ITE/GCL08/PW401793/Lab03") {
                    sh 'docker build . -t bashtop-test -f Dockerfile-test'
                    sh 'docker run -t bashtop-test'
                }
            }
        }
    }
}

