pipeline {
			
	agent any

	stages {
		stage('Clone git repo') {
			steps {
				echo 'Creating volme to input'
				sh 'docker volume create input-volume'
				sh 'docker rm temp-container || true'
				sh 'docker run -v input-volume:/data --name temp-container node'
				sh 'cd ~/ && ls node-red || git clone --recurse-submodules https://github.com/node-red/node-red.git'
				sh 'docker cp ~/node-red temp-container:/data'
				sh 'docker rm temp-container'
			}
		}
	
	stage('Build') {
			steps {
				echo 'Building node-red with npm'
				dir("./ITE/GCL08/MW401139") {
				    sh 'pwd'
				    sh 'ls'
					sh 'docker build . -t build-image -f docker_build'
					sh 'docker volume create output-volume'
					sh 'docker run --mount type=volume,src="input-volume",dst=/node-red_app --mount type=volume,src="output-volume",dst=/node-red_build build-image bash -c "cd /node-red_app/node-red && npm i;ls;pwd"'
				}
			}
		}

    stage('Test') {
            steps {
    		    echo 'Testing bashtop'
      	        dir("./ITE/GCL08/MW401139") {
      		        sh 'docker build . -t test-image -f docker_test'
      		        sh 'docker run -t --mount type=volume,src="input-volume",dst=/node-red_build test-image bash -c "cd /node-red_build/node-red && npm run test"'
                }
      	    }
        }
	}
}