pipeline {

  agent any

  parameters {
    string(name: 'Version', defaultValue: '1.0.0', description: 'Version')
    booleanParam(name: 'Promote', defaultValue: true, description: 'Promote statement')
    string(name: 'Dockerfiles', defaultValue: './ITE/GCL08/BT403177/Lab05', description: 'Dockerfiles path')
  }

  stages {

    stage('Clone') {
      steps {
        echo 'Cloning cropperjs'
        sh 'docker volume create input-volume'
        sh 'docker rm tempContainer || true'
        sh 'docker run --rm --name tempContainer --mount "type=volume,src=input-volume,dst=/myapp" node bash -c "cd ~/ mkdir cropperjs || git clone https://github.com/fengyuanchen/cropperjs ;cp -R cropperjs /myapp; ls /myapp"'
      }
    }

    stage('Build') {
      steps {
        echo 'Buildig cropperjs with npm'
        dir("${params.Dockerfiles}") {
          sh 'docker build . -t cropperjs -f Dockerfile'
          sh 'docker volume create output-volume'
          sh 'docker rm calculator-build || true'
          sh 'docker run --rm --name cropperjs-build --mount "type=volume,src=input-volume,dst=/myapp" --mount "type=volume,src=output-volume,dst=/myapp_build" cropperjs bash -c "cd /myapp/cropperjs && npm install; cp -R /myapp/cropperjs /myapp_build"'
        }
      }
    }

    stage('Test') {
      steps {
        echo 'Testing cropperjs with npm'
        dir("${params.Dockerfiles}") {
          sh 'docker rm cropperjs-test || true'
          sh 'docker run --rm --name cropperjs-test --mount "type=volume,src=input-volume,dst=/myapp_test" cropperjs bash -c "cd /myapp_test/cropperjs && npm test"'
        }
      }
    }

    stage('Deploy') {
      steps {
        echo 'Deploying cropperjs'
        sh 'docker rm -f cropperjs-deploy || true'
        sh 'docker run --name cropperjs-deploy --mount "type=volume,src=output-volume,dst=/usr/local/myapp" cropperjs bash -c "cd /usr/local/myapp/cropperjs && npm run"'
        sh 'sleep 5; exit $(docker inspect cropperjs-deploy --format="{{.State.ExitCode}}")'
        sh 'docker rm -f cropperjs-deploy'
      }
    }

    stage('Prepare publish') {
      when {
        expression {
          return params.Promote
        }
      }
      steps {
        echo 'Preparing publish'
        sh 'ls /var/jenkins_home/workspace/artifacts || mkdir /var/jenkins_home/workspace/artifacts'
      }
    }
	stage('Publish') {
      when {
        expression {
          return params.Promote
        }
      }
      agent {
        docker {
          image 'node:alpine'
          args '--rm --mount "type=volume,src=output-volume,dst=/usr/local/myapp" --mount "type=bind,source=/var/jenkins_home/workspace/artifacts,dst=/usr/local/copy" -u root:root'
        }
      }
      steps {
        sh 'rm -rf /usr/local/copy/* || true'
        sh "cd /usr/local/myapp/calculator && npm version --allow-same-version ${params.Version} && npm pack"
        sh "mv /usr/local/myapp/calculator/calculator-${params.Version}.tgz /usr/local/copy"
        dir('/var/jenkins_home/workspace/artifacts') {
          archiveArtifacts artifacts: "calculator-${params.Version}.tgz"
        }
      }
    }
  }
}
