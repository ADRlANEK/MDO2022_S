pipeline 
{
	parameters
    	{
        string(name: 'VERSION', defaultValue: '1.0.0', description: '')
        booleanParam(name: 'PROMOTE', defaultValue: true, description: '')
    	}		
	agent any
	stages 
	{
	stage('Clone') 
        	{
                 steps {	
		sh "docker system prune --all -f"
             	sh 'docker volume  create --name repo_vol'
             	sh 'docker volume  create --name build_vol'
             	sh "docker build -t clone . -f ./ITE/GCL06/AP304152/Lab05/docker_clone"
             	sh "docker run -v repo_vol:/Cytoscape clone"           
        		}
		}

        stage('Build') 
        	{
		steps {
               sh 'docker build -t build . -f ./ITE/GCL06/AP304152/Lab05/docker_build'
	       sh 'docker run --name build_container -v repo_vol:/Cytoscape -v build_vol:/build build'
            	      }
        	}
		
	stage('Test') 
       		{
		steps{
               sh 'docker build -t test . -f ./ITE/GCL06/AP304152/Lab05/docker_test'
               sh 'docker run --name test_container -v repo_vol:/Cytoscape test'
                      }
        	}
	
	stage('Deploy') 
		{
	     steps {
		echo 'Deploy app'
		sh 'docker rm -f container_deploy || true'
		sh 'docker run -d --name container_deploy --mount type=volume,src="build_vol",dst=/app node bash -c "cd /app/cytoscape.js && npm run test"'
		sh 'sleep 30; exit $(docker inspect container_deploy --format="{{.State.ExitCode}}")'
		sh 'docker rm -f container_deploy'
		    }
		}
	stage('Publish') 
		{
	when {
                expression {return params.PROMOTE}
             }
	agent {
        docker {
                image 'node:alpine'
                args '--rm --mount "type=volume,src=output,dst=/usr/local/app" --mount "type=bind,src=/var/jenkins_home/workspace/artifacts,dst=/usr/local/copy" -u root:root'
               }
      	      }
	      steps {
		echo 'Create and publish'
		sh 'rm -f /usr/local/copy/* || true'
		sh "cd /usr/local/app/cytoscape.js && npm version ${params.VERSION} && npm pack"
		sh "mv /usr/local/app/cytoscape.js/cytoscape-${params.VERSION}.tgz /usr/local/copy"
		dir('/var/jenkins_home/workspace/artifacts'){
                archiveArtifacts artifacts: "*.tgz"
		echo 'Creatin and publishing complete'
		     }
		}
		}	
            
	
	}
}
