pipeline
{
 parameters {
        booleanParam(name: "promote",
            defaultValue: false,
            description: "Promote to new version, when successful?")
        string(name: "version",
            defaultValue: "",
            description: "Type in verion number:")
    }
	agent any
	stages
	{
		stage('Build')
		{
			steps
			{
				sh '''
				echo "Budowanie projektu..."
				docker rm -f ro_build
				docker volume prune -f
				docker volume  create --name volume_input
				docker volume  create --name volume_output
				docker build . -f ./ITE/GCL06/RO400876/lab05/RO_Dockerfile_Build -t ro_build
                    		docker run --mount type=volume,src="ro_build",dst=/volume_input ro_build:latest bash -c "cd .. &&  cp -r /cytoscape.js /volume_input && cp -r /volume_input /volume_output && ls ./volume_input && ls ./volume_output"  	      
                    		echo "Budowanie zakończone"
				'''
				
			}
		}
		
		stage('Test')
		{
			steps
			{
				sh '''
				echo "Testowanie projektu..."
				
				docker rm -f RO_Dockerfile_Test
				docker build . -f ./ITE/GCL06/RO400876/lab05/RO_Dockerfile_Test -t ro_test
				docker run --name test_container --rm --mount source=ro_test,target=/volume_input ro_test:latest
				
				echo "Testowanie zakończone"
				'''
			}
		}
		
		 stage('Deploy')
        {
            steps
            {
                sh '''
                echo "Wdrażanie projektu..."
                
                docker rm -f deploy_container
                docker run -dit --name deploy_container --mount type=volume,src="volume_output",dst=/ro_project node
                docker container exec deploy_container sh -c "ls -l"
                exit $(docker inspect deploy_container --format="{{.State.ExitCode}}")
                echo "Wdrażanie zakończone"
            	 '''
            }
        }
        
        stage ('Publish')
        {
           
            steps
            {
            	script
            	{
            	
                if(params.promote) {
                        sh "find ./artifacts -type f -name '*' -printf \"mv '%h/%f' '%h/${params.version}_%f'\" | sh"
                        sh "ls -a ./artifacts"
                        archiveArtifacts artifacts: "artifacts/*.jar"
                    }
                    else {
                        echo "ERROR!!!!!!!!!!!!!!!!!!!!!!!!!"
                    }   
                
                
            }
        }
        }
	}
}
