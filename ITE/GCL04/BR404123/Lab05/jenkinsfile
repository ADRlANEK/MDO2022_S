pipeline {
    agent any
    parameters {
        string(name: 'VERSION', defaultValue: '1.0.0', description: '')
        booleanParam(name: 'PROMOTE', defaultValue: false, description: '')
    }
    stages {
    	stage('Prepare') {
    	    steps {
            	sh 'echo Uruchomiono Prepare'
    	    	sh 'mkdir artifact -p'
    	    	sh 'ls'
    	    	sh 'pwd'
    	        sh 'chmod 777 -R artifact'
    	    	sh 'docker volume create --name input_v'
    	    	sh 'docker volume create --name output_v'
    	    }
    	}
        stage('Build') {
            steps {
                sh 'echo Uruchomiono Build'
                sh 'docker build -t lab05_builder . -f ITE/GCL04/BR404123/Lab05/dockerfile_builder'
                sh 'docker run -v input_v:/input_v -v output_v:/output_v -v ${PWD}/artifact:/artifact lab05_builder'
                sh 'ls'
                sh 'ls artifact'
            }
        }
        stage('Test') {
            steps {
                sh 'echo Uruchomiono Test'
                sh 'docker build -t lab05_tester . -f ITE/GCL04/BR404123/Lab05/dockerfile_tester'
                sh 'docker run -v input_v:/input_v lab05_tester'
                sh 'ls'
            }
        }
        stage('Deploy') {
            steps {
                sh 'echo Uruchomiono Deploy'
                sh 'docker build -t lab05_deploy . -f ITE/GCL04/BR404123/Lab05/dockerfile_deploy'
                sh 'docker run -v output_v:/output_v lab05_deploy'
                sh 'ls'
            }
        }
        stage('Publish') {
            when {
                environment name: 'PROMOTE', value: "true"
            }
            steps {
                sh 'echo Uruchomiono Publish'
                sh 'ls'
                archiveArtifacts artifacts: '*.jar', fingerprint: true
                junit '*.xml'
            }
        }
    }
    post {
    	always {
            sh 'ls'
    	    sh 'chmod 777 -R artifact'
    	    sh 'rm -rf artifact'
    	}
   }
}
