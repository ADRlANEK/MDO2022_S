pipeline {
    agent any
    
    stages {
        stage('build') {
            steps {
		sh 'docker kill tempContainer || true'
		sleep 1
                sh 'docker build -t buildirssi . -f ITE/GCL04/SK403390/Lab05/DockerfileBuild'
		sh 'docker run --name tempContainer -dit --rm buildirssi'
		sh 'rm -r fe-text || true'
		sh 'rm -r irssi || true'
		sh 'docker container exec tempContainer ls'
		sh 'docker container exec tempContainer ls ..'
		sh 'docker container exec tempContainer ls build/src/fe-text'
		sh 'docker cp tempContainer:irssi/build/src/fe-text .'
		sh 'docker cp tempContainer:irssi .'
		sh 'docker kill tempContainer'
		sh 'ls irssi/build/src/fe-text'
            }
        }
        stage('test') {
            steps {
                sh 'docker build -t testirssi . -f ITE/GCL04/SK403390/Lab05/DockerfileTest'
		sh 'docker run testirssi'
            }
        }
	stage('deploy') {
	    steps {
		sh 'echo "Do uruchomienia programu wymagane jest zainstalowanie bibliotek libglib2.0 i libutf8proc-dev" > installationInfo'
		sh 'cat installationInfo'
		sh 'docker ps -a'
		sh "docker container kill deployContainer3 || true"
		sleep 1
		sh 'docker run --rm --name deployContainer3 -dit ubuntu'
		sh 'docker cp fe-text deployContainer3:.'
		sh 'docker container exec deployContainer3 sh -c "apt-get update"'
		sh 'docker container exec deployContainer3 sh -c "DEBIAN_FRONTEND="noninteractive" apt-get install -y libglib2.0"'
		sh "docker container exec deployContainer3 sh -c 'apt-get install -y libutf8proc-dev'"
		sh 'docker container exec deployContainer3 ls -al fe-text'
		sh "docker container exec deployContainer3 sh -c './fe-text/irssi --version'"
		sh "docker container kill deployContainer3"
	    }
	}
	stage('publish') {
	    when {
		expression {
		    return params.promote == $true;
		}
	    }
	    steps {
		sh 'cp installationInfo fe-text'
		echo params.version
		archiveArtifacts artifacts: 'fe-text/irssi'
	    }
	}
    }
}
