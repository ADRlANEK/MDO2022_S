pipeline {
    agent any

    parameters {
        string(name: 'Name')
        string(name: 'Version')
    }

    stages{
        stage('Build') {
            steps {
                dir('INO/GCL01/DG306441/Lab05') {
                    sh 'docker build . -f DockerFile1 -t build'
                }
            }
        }
        stage('Tests') {
            steps {
                dir('INO/GCL01/DG306441/Lab05') {
                    sh 'docker build . -f DockerFile2 -t test'
                }
            }
        }
	stage('Deploy') {
            steps {
                sh 'docker run --volume /var/jenkins_home/workspace/NewPipeline/INO/GCL01/DG306441/Lab05:/v1 build mv pcalc /v1'
                dir('INO/GCL01/DG306441/Lab05') {
                    sh 'docker build . -f DockerFile3 -t deploy'
                }
                sh 'docker run --volume /var/jenkins_home/workspace/NewPipeline/INO/GCL01/DG306441/Lab05:/v2 -d -p 3000:80 deploy'
                sh 'docker stop $(docker ps -a -q)'
            }
        }
	stage('Publish') {
            steps {
		echo "${params.Name}-${params.Version}"
                dir('INO/GCL01/DG306441/Lab05') {
                    sh 'docker build . -f DockerFile4 -t publish'
                }
                sh 'docker run --volume /var/jenkins_home/workspace/NewPipeline/INO/GCL01/DG306441/Lab05:/v1 publish "mv publish.tar ${params.Name}-${params.Version}.tar ; mv ${params.Name}-${params.Version}.tar /v1"'
            }
        }
    }
}
