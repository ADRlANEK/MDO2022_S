pipeline {
    agent any
    stages{
        stage('Build') {
            steps {
                echo 'BUILD'
                git branch: 'DK306669_termin2', url: 'https://github.com/InzynieriaOprogramowaniaAGH/MDO2022_S.git'
                dir('./INO/termin2/DK306669') {
                    sh 'docker build . -f build.dockerfile -t builder'
                    sh 'docker volumne create exit_volume'
                    sh 'docker run --mount type=volume,src="entry_volume",dst=/nodejs.org --mount type=volume,src="exit_volume",dst=/build bash -c "cd /nodejs.org && npm i -g; cd ..; cp -r build"'
                }
            }
        }
        stage('Tests') {
            steps {
                echo 'TESTS'
                dir('INO/termin2/DK306669') {
                    sh 'docker build . -f test.dockerfile -t tester'
                }
            }
        }
        stage('Deploy') {
            steps {
                echo 'DEPLOY'
                dir('./INO/termin2/DK306669') {
                    sh 'docker build . -f build.dockerfile -t deploy'
                }
                sh 'docker run --rm --name deploy --mount type=volume,src="exit_volume",dst=/nodejs.org deploy_image bash =c "cd /nodejs.org && npm run"'
            }
        }    
          stage('Publish') {
            steps {
                echo 'PUBLISH'
                dir('INO/termin2/DK306669') {
                    sh 'docker build . -f publish.dockerfile -t publisher'
                }
                sh "docker run --volume /var/jenkins_home/workspace/PipeLine/INO/termin2/DK306669:/finalArchive publisher mv archive.tar.xz /finalArchive"
            }
        }   
    }
}
